<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Camera Management - Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,300;0,400;0,700;0,900;1,300;1,400;1,700;1,900&display=swap" rel="stylesheet">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
</head>
<body>
    <div class="dashboard-container">
        <header class="dashboard-header">
            <h1>AI Camera Management</h1>
            <div class="user-info">
                <span>Welcome, <span id="userName"></span>!</span>
                <button onclick="logout()" class="logout-btn">Logout</button>
            </div>
        </header>
        
        <nav class="dashboard-nav">
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="dashboard.html" class="nav-link active">Dashboard</a>
                </li>
                <li class="nav-item">
                    <a href="productions.html" class="nav-link">Productions</a>
                </li>
                <li class="nav-item">
                    <a href="equipment.html" class="nav-link">Equipment</a>
                </li>
                <li class="nav-item">
                    <a href="installations.html" class="nav-link">Installations</a>
                </li>
                <li class="nav-item">
                    <a href="finance.html" class="nav-link">Finance</a>
                </li>
            </ul>
        </nav>
        
        <main class="dashboard-content">
            <h2>Dashboard</h2>
            
            <!-- Stats Cards and Chart -->
            <div class="dashboard-overview">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-info">
                            <h3>Total Cameras</h3>
                            <p class="stat-number" id="totalCameras">-</p>
                        </div>
                    </div>
                    
                    <div class="stat-card active">
                        <div class="stat-info">
                            <h3>Active Cameras</h3>
                            <p class="stat-number" id="activeCameras">-</p>
                        </div>
                    </div>
                    
                    <div class="stat-card pending">
                        <div class="stat-info">
                            <h3>Pending Installation</h3>
                            <p class="stat-number" id="pendingCameras">-</p>
                        </div>
                    </div>
                    
                    <div class="stat-card inactive">
                        <div class="stat-info">
                            <h3>Inactive Cameras</h3>
                            <p class="stat-number" id="inactiveCameras">-</p>
                        </div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <h3>Status Distribution</h3>
                    <div class="stacked-bar-wrapper">
                        <div class="stacked-bar" id="stackedBar">
                            <div class="bar-segment active" id="activeSegment"></div>
                            <div class="bar-segment pending" id="pendingSegment"></div>
                            <div class="bar-segment inactive" id="inactiveSegment"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Weltkarte für Kamera-Standorte -->
            <div class="map-section">
                <h3>AI Camera Locations Worldwide</h3>
                <div id="worldMap" class="world-map"></div>
                <div class="map-legend">
                    <div class="legend-item">
                        <span class="legend-color active"></span>
                        <span>Active</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color pending"></span>
                        <span>Pending Installation</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color inactive"></span>
                        <span>Inactive/Storage</span>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <script>
        // Check if user is logged in
        const currentUser = localStorage.getItem('currentUser');
        if (!currentUser) {
            window.location.href = 'index.html';
        } else {
            document.getElementById('userName').textContent = JSON.parse(currentUser).fullName;
        }
        
        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'index.html';
        }
        
        // Globale Variablen für die Karte
        let worldMap;
        let cameraData = [];
        
        // CSV-Daten laden und Kennzahlen berechnen
        async function loadCameraStats() {
            try {
                const response = await fetch('ai_cameras.csv');
                const csvText = await response.text();
                
                // CSV parsen
                const lines = csvText.split('\n');
                const headers = lines[0].split(',');
                const statusIndex = headers.indexOf('Status');
                const addressIndex = headers.indexOf('Address');
                const locationIndex = headers.indexOf('Location');
                const idIndex = headers.indexOf('ID');
                const arenaIndex = headers.indexOf('Arena');
                
                let totalCameras = 0;
                let activeCameras = 0;
                let inactiveCameras = 0;
                let pendingCameras = 0;
                
                // Kamera-Daten für die Karte sammeln
                cameraData = [];
                
                // Daten durchgehen (erste Zeile sind Headers, also ab Index 1)
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line) { // Nur nicht-leere Zeilen
                        const columns = line.split(',');
                        if (columns.length > statusIndex) {
                            totalCameras++;
                            const status = columns[statusIndex].trim();
                            const address = columns[addressIndex] ? columns[addressIndex].replace(/"/g, '').trim() : '';
                            const location = columns[locationIndex] ? columns[locationIndex].trim() : '';
                            const id = columns[idIndex] ? columns[idIndex].trim() : '';
                            const arena = columns[arenaIndex] ? columns[arenaIndex].trim() : '';
                            
                            // Kamera-Daten für Karte sammeln (nur wenn Adresse vorhanden)
                            if (address) {
                                cameraData.push({
                                    id: id,
                                    location: location,
                                    address: address,
                                    arena: arena,
                                    status: status || 'pending'
                                });
                            }
                            
                            if (status === 'Active') {
                                activeCameras++;
                            } else if (status === 'Storage') {
                                inactiveCameras++;
                            } else if (status === '' || !status) {
                                pendingCameras++;
                            }
                        }
                    }
                }
                
                // Kennzahlen in die HTML-Elemente eintragen
                document.getElementById('totalCameras').textContent = totalCameras;
                document.getElementById('activeCameras').textContent = activeCameras;
                document.getElementById('inactiveCameras').textContent = inactiveCameras;
                document.getElementById('pendingCameras').textContent = pendingCameras;
                
                // Balkendiagramm aktualisieren
                updateBarChart(activeCameras, pendingCameras, inactiveCameras);
                
                // Karte laden
                loadWorldMap();
                
            } catch (error) {
                console.error('Fehler beim Laden der Kamera-Daten:', error);
                // Fallback-Werte bei Fehler
                document.getElementById('totalCameras').textContent = 'Fehler';
                document.getElementById('activeCameras').textContent = 'Fehler';
                document.getElementById('inactiveCameras').textContent = 'Fehler';
                document.getElementById('pendingCameras').textContent = 'Fehler';
            }
        }
        
        // Gestapelten Balken aktualisieren
        function updateBarChart(active, pending, inactive) {
            const total = active + pending + inactive;
            
            if (total === 0) {
                // Alle Segmente auf 0% setzen
                document.getElementById('activeSegment').style.width = '0%';
                document.getElementById('pendingSegment').style.width = '0%';
                document.getElementById('inactiveSegment').style.width = '0%';
                return;
            }
            
            // Prozentsätze berechnen
            const activePercent = (active / total) * 100;
            const pendingPercent = (pending / total) * 100;
            const inactivePercent = (inactive / total) * 100;
            
            // Segmente animiert setzen
            setTimeout(() => {
                document.getElementById('activeSegment').style.width = activePercent + '%';
                document.getElementById('pendingSegment').style.width = pendingPercent + '%';
                document.getElementById('inactiveSegment').style.width = inactivePercent + '%';
            }, 100);
        }
        
        // Weltkarte initialisieren
        function initWorldMap() {
            // Karte mit Zentrum in Europa initialisieren
            worldMap = L.map('worldMap').setView([50.1109, 8.6821], 4);
            
            // OpenStreetMap Tile Layer hinzufügen
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(worldMap);
        }
        
        // Kamera-Marker zur Karte hinzufügen
        async function loadWorldMap() {
            // Karte initialisieren falls noch nicht geschehen
            if (!worldMap) {
                initWorldMap();
            }
            
            console.log('Lade Kamera-Standorte auf Karte:', cameraData);
            
            // Für jede Kamera einen Marker hinzufügen
            for (const camera of cameraData) {
                try {
                    const coords = await geocodeAddress(camera.address);
                    if (coords) {
                        addCameraMarker(coords.lat, coords.lng, camera);
                    }
                } catch (error) {
                    console.error(`Fehler beim Geocoding von ${camera.address}:`, error);
                }
            }
        }
        
        // Adresse zu Koordinaten umwandeln (Geocoding)
        async function geocodeAddress(address) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`);
                const data = await response.json();
                
                if (data && data.length > 0) {
                    return {
                        lat: parseFloat(data[0].lat),
                        lng: parseFloat(data[0].lon)
                    };
                }
                return null;
            } catch (error) {
                console.error('Geocoding Fehler:', error);
                return null;
            }
        }
        
        // Kamera-Marker zur Karte hinzufügen
        function addCameraMarker(lat, lng, camera) {
            // Farbe basierend auf Status bestimmen
            let markerColor = '#28a745'; // Grün für Active
            if (camera.status === 'Storage') {
                markerColor = '#dc3545'; // Rot für Storage/Inactive
            } else if (camera.status === 'pending' || camera.status === '') {
                markerColor = '#ffc107'; // Gelb für Pending
            }
            
            // Custom Marker Icon erstellen
            const markerIcon = L.divIcon({
                className: 'custom-marker',
                html: `<div style="
                    width: 12px; 
                    height: 12px; 
                    background-color: ${markerColor}; 
                    border: 2px solid white; 
                    border-radius: 50%; 
                    box-shadow: 0 1px 3px rgba(0,0,0,0.4);
                "></div>`,
                iconSize: [16, 16],
                iconAnchor: [8, 8]
            });
            
            // Popup-Content erstellen
            const popupContent = `
                <div style="min-width: 200px;">
                    <strong>Camera ID: ${camera.id}</strong><br>
                    <strong>Location:</strong> ${camera.location || 'N/A'}<br>
                    <strong>Arena:</strong> ${camera.arena || 'N/A'}<br>
                    <strong>Address:</strong> ${camera.address}<br>
                    <strong>Status:</strong> <span style="color: ${markerColor}; font-weight: bold;">
                        ${camera.status === 'Active' ? 'Active' : 
                          camera.status === 'Storage' ? 'Inactive/Storage' : 
                          'Pending Installation'}
                    </span>
                </div>
            `;
            
            // Marker zur Karte hinzufügen
            L.marker([lat, lng], { icon: markerIcon })
                .addTo(worldMap)
                .bindPopup(popupContent);
        }
        
        // Kennzahlen beim Laden der Seite aktualisieren
        document.addEventListener('DOMContentLoaded', loadCameraStats);
    </script>
</body>
</html> 