<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Camera Management - Equipment</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,300;0,400;0,700;0,900;1,300;1,400;1,700;1,900&display=swap" rel="stylesheet">
    <!-- HLS.js for video streaming -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1.4.12/dist/hls.min.js"></script>
</head>
<body>
    <div class="dashboard-container">
        <header class="dashboard-header">
            <h1>AI Camera Management</h1>
            <div class="user-info">
                <span>Welcome, <span id="userName"></span>!</span>
                <button onclick="logout()" class="logout-btn">Logout</button>
            </div>
        </header>
        
        <nav class="dashboard-nav">
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="dashboard.html" class="nav-link">Dashboard</a>
                </li>
                <li class="nav-item">
                    <a href="productions.html" class="nav-link">Productions</a>
                </li>
                <li class="nav-item">
                    <a href="equipment.html" class="nav-link active">Equipment</a>
                </li>
                <li class="nav-item">
                    <a href="installations.html" class="nav-link">Installations</a>
                </li>
                <li class="nav-item">
                    <a href="finance.html" class="nav-link">Finance</a>
                </li>
            </ul>
        </nav>
        
        <main class="dashboard-content">
            <h2>Equipment</h2>
            
            <!-- Länder-Filter -->
            <div class="country-filter-section">
                <div class="filter-group">
                    <label for="countryFilter">Filter by Country:</label>
                    <select id="countryFilter" onchange="applyCountryFilter()">
                        <option value="">All Countries</option>
                    </select>
                </div>
            </div>
            
            <!-- Aktive Kameras -->
            <div class="equipment-section active-section">
                <div class="section-header">
                    <h3>Active Cameras</h3>
                    <button class="add-camera-btn" onclick="openAddCameraModal()">
                        <span>+</span> Add Camera
                    </button>
                </div>
                <div class="equipment-table-container">
                    <table class="equipment-table active" id="activeCamerasTable">
                        <thead>
                            <tr>
                                <th>Live Stream</th>
                                <th>Camera ID</th>
                                <th>Location</th>
                                <th>Arena</th>
                                <th>IP Address</th>
                                <th>Installation Date</th>
                                <th>Status</th>
                                <th>Details</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="activeCamerasBody">
                            <!-- Dynamisch geladen -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Zu installierende Kameras -->
            <div class="equipment-section pending-section">
                <h3>Cameras to Install</h3>
                <div class="equipment-table-container">
                    <table class="equipment-table pending" id="pendingCamerasTable">
                        <thead>
                            <tr>
                                <th>Camera ID</th>
                                <th>Location</th>
                                <th>Arena</th>
                                <th>Installation Type</th>
                                <th>Address</th>
                                <th>Status</th>
                                <th>Details</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="pendingCamerasBody">
                            <!-- Dynamisch geladen -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Inaktive Kameras -->
            <div class="equipment-section inactive-section">
                <h3>Inactive Cameras</h3>
                <div class="equipment-table-container">
                    <table class="equipment-table inactive" id="inactiveCamerasTable">
                        <thead>
                            <tr>
                                <th>Camera ID</th>
                                <th>Location</th>
                                <th>Arena</th>
                                <th>IP Address</th>
                                <th>Uninstallation Date</th>
                                <th>Status</th>
                                <th>Details</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="inactiveCamerasBody">
                            <!-- Dynamisch geladen -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Modal für Kamera-Details -->
    <div id="cameraDetailsModal" class="modal">
        <div class="modal-content camera-details-modal">
            <div class="modal-header">
                <h3 id="cameraDetailsTitle">Camera Details</h3>
                <span class="modal-close" onclick="closeCameraDetailsModal()">&times;</span>
            </div>
            <div class="modal-body camera-details-body">
                <!-- Zwei-spalten Layout: Links Details, Rechts Bilder -->
                <div class="details-container">
                    <div class="details-left">
                        <h4>Technical Information</h4>
                        <div id="cameraDetailsContent" class="details-grid">
                            <!-- Dynamisch geladen -->
                        </div>
                    </div>
                    <div class="details-right">
                        <h4>Camera Images</h4>
                        <div id="cameraImageGallery" class="image-gallery">
                            <!-- Dynamisch geladen -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeCameraDetailsModal()">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Modal für neue Kamera hinzufügen -->
    <div id="addCameraModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Camera</h3>
                <span class="modal-close" onclick="closeAddCameraModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="addCameraForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="cameraId">Camera ID *</label>
                            <input type="text" id="cameraId" name="cameraId" required>
                        </div>
                        <div class="form-group">
                            <label for="location">Location *</label>
                            <input type="text" id="location" name="location" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="address">Address</label>
                            <input type="text" id="address" name="address">
                        </div>
                        <div class="form-group">
                            <label for="arena">Arena</label>
                            <input type="text" id="arena" name="arena">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="installationType">Installation Type</label>
                            <select id="installationType" name="installationType">
                                <option value="">Select Type</option>
                                <option value="Mobile">Mobile</option>
                                <option value="Permanent">Permanent</option>
                                <option value="Tournament Service">Tournament Service</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="ipAddress">IP Address</label>
                            <input type="text" id="ipAddress" name="ipAddress">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="installationDate">Installation Date</label>
                            <input type="date" id="installationDate" name="installationDate">
                        </div>
                        <div class="form-group">
                            <label for="serverId">Server ID</label>
                            <input type="text" id="serverId" name="serverId" placeholder="e.g. fhdb9b6f">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="status">Status *</label>
                            <select id="status" name="status" required>
                                <option value="">Select Status</option>
                                <option value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                                <option value="Installation">Pending Installation</option>
                                <option value="Storage">Storage</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="eventManager">Event Manager</label>
                            <input type="text" id="eventManager" name="eventManager">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="localContact">Local Contact</label>
                            <input type="text" id="localContact" name="localContact">
                        </div>
                        <div class="form-group"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeAddCameraModal()">Cancel</button>
                <button type="button" class="btn-primary" onclick="saveNewCamera()">Save Camera</button>
            </div>
        </div>
    </div>
    
    <!-- Modal für Kamera bearbeiten -->
    <div id="editCameraModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Camera</h3>
                <span class="modal-close" onclick="closeEditCameraModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="editCameraForm">
                    <input type="hidden" id="editCameraRowId" name="editCameraRowId">
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editCameraId">Camera ID *</label>
                            <input type="text" id="editCameraId" name="editCameraId" required>
                        </div>
                        <div class="form-group">
                            <label for="editLocation">Location *</label>
                            <input type="text" id="editLocation" name="editLocation" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editAddress">Address</label>
                            <input type="text" id="editAddress" name="editAddress">
                        </div>
                        <div class="form-group">
                            <label for="editArena">Arena</label>
                            <input type="text" id="editArena" name="editArena">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editInstallationType">Installation Type</label>
                            <select id="editInstallationType" name="editInstallationType">
                                <option value="">Select Type</option>
                                <option value="Mobile">Mobile</option>
                                <option value="Permanent">Permanent</option>
                                <option value="Tournament Service">Tournament Service</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editIpAddress">IP Address</label>
                            <input type="text" id="editIpAddress" name="editIpAddress">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editInstallationDate">Installation Date</label>
                            <input type="date" id="editInstallationDate" name="editInstallationDate">
                        </div>
                        <div class="form-group">
                            <label for="editUninstallationDate">Uninstallation Date</label>
                            <input type="date" id="editUninstallationDate" name="editUninstallationDate">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editServerId">Server ID</label>
                            <input type="text" id="editServerId" name="editServerId" placeholder="e.g. fhdb9b6f">
                        </div>
                        <div class="form-group">
                            <label for="editStatus">Status *</label>
                            <select id="editStatus" name="editStatus" required>
                                <option value="">Select Status</option>
                                <option value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                                <option value="Installation">Pending Installation</option>
                                <option value="Storage">Storage</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editEventManager">Event Manager</label>
                            <input type="text" id="editEventManager" name="editEventManager">
                        </div>
                        <div class="form-group">
                            <label for="editLocalContact">Local Contact</label>
                            <input type="text" id="editLocalContact" name="editLocalContact">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-danger" onclick="deleteCamera()">Delete</button>
                <button type="button" class="btn-secondary" onclick="closeEditCameraModal()">Cancel</button>
                <button type="button" class="btn-primary" onclick="saveEditedCamera()">Save Changes</button>
            </div>
        </div>
    </div>
    
    <script>
        // Check if user is logged in
        const currentUser = localStorage.getItem('currentUser');
        if (!currentUser) {
            window.location.href = 'index.html';
        } else {
            document.getElementById('userName').textContent = JSON.parse(currentUser).fullName;
        }
        
        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'index.html';
        }
        
        // Globale Variablen
        let camerasData = [];
        let hlsPlayers = {};
        let currentEditingCameraId = null;
        
        // CSV-Daten laden und Equipment anzeigen
        async function loadEquipmentData() {
            try {
                // Prüfe ob lokale Änderungen vorhanden sind
                const localData = localStorage.getItem('camerasData');
                
                if (localData) {
                    // Verwende lokale Daten
                    camerasData = JSON.parse(localData);
                } else {
                    // CSV laden
                    const response = await fetch('ai_cameras.csv');
                    const csvText = await response.text();
                    
                    // CSV parsen
                    camerasData = parseCSV(csvText);
                }
                
                // Debug: Kamera-Kategorisierung
                debugCameraCategories();
                
                // Länder-Dropdown befüllen
                populateCountryFilter();
                
                // Equipment-Tabellen anzeigen
                displayActiveCameras();
                displayPendingCameras();
                displayInactiveCameras();
                
            } catch (error) {
                console.error('Fehler beim Laden der Equipment-Daten:', error);
            }
        }
        
        // Debug-Funktion: Zeige Kamera-Kategorisierung
        function debugCameraCategories() {
            console.log('=== CAMERA CATEGORIZATION DEBUG ===');
            console.log(`Total cameras loaded: ${camerasData.length}`);
            
            const activeCameras = camerasData.filter(camera => camera['Status'] === 'Active');
            const pendingCameras = camerasData.filter(camera => {
                const status = camera['Status'];
                return status === '' || 
                       status === 'pending' || 
                       status === 'Installation' ||
                       status === 'Pending Installation' ||
                       (!status && camera['Camera-ID']);
            });
            const inactiveCameras = camerasData.filter(camera => {
                const status = camera['Status'];
                return status === 'Inactive' || 
                       status === 'Storage' || 
                       status === 'Offline' ||
                       status === 'Decommissioned' ||
                       status === 'Stored';
            });
            
            console.log(`Active cameras: ${activeCameras.length}`);
            activeCameras.forEach(cam => console.log(`  - ${cam['Camera-ID']} (${cam['Location']}) - Status: "${cam['Status']}"`));
            
            console.log(`Pending cameras: ${pendingCameras.length}`);
            pendingCameras.forEach(cam => console.log(`  - ${cam['Camera-ID']} (${cam['Location']}) - Status: "${cam['Status']}"`));
            
            console.log(`Inactive cameras: ${inactiveCameras.length}`);
            inactiveCameras.forEach(cam => console.log(`  - ${cam['Camera-ID']} (${cam['Location']}) - Status: "${cam['Status']}"`));
            
            const totalCategorized = activeCameras.length + pendingCameras.length + inactiveCameras.length;
            console.log(`Total categorized: ${totalCategorized}`);
            
            if (totalCategorized !== camerasData.length) {
                console.warn('⚠️ MISSING CAMERAS - Some cameras are not categorized!');
                const uncategorized = camerasData.filter(camera => {
                    const status = camera['Status'];
                    const isActive = status === 'Active';
                    const isPending = status === '' || status === 'pending' || status === 'Installation' || status === 'Pending Installation' || (!status && camera['Camera-ID']);
                    const isInactive = status === 'Inactive' || status === 'Storage' || status === 'Offline' || status === 'Decommissioned' || status === 'Stored';
                    return !isActive && !isPending && !isInactive;
                });
                console.log(`Uncategorized cameras: ${uncategorized.length}`);
                uncategorized.forEach(cam => console.log(`  - ${cam['Camera-ID']} (${cam['Location']}) - Status: "${cam['Status']}"`));
            }
            
            console.log('=== END DEBUG ===');
        }
        
        // CSV-Parser Funktion
        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line) {
                    const values = parseCSVLine(line);
                    if (values.length === headers.length) {
                        const row = {};
                        headers.forEach((header, index) => {
                            row[header] = values[index];
                        });
                        data.push(row);
                    }
                }
            }
            return data;
        }
        
        // CSV-Zeile parsen (berücksichtigt Anführungszeichen)
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }
        
        // Aktive Kameras anzeigen
        function displayActiveCameras(selectedCountry = '') {
            const tbody = document.getElementById('activeCamerasBody');
            tbody.innerHTML = '';
            
            let activeCameras = camerasData.filter(camera => camera['Status'] === 'Active');
            activeCameras = sortCamerasByCountry(activeCameras, selectedCountry);
            
            activeCameras.forEach((camera, index) => {
                const serverId = camera['Server-ID'];
                const hasStream = serverId && serverId.trim() !== '';
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td class="stream-cell">
                        ${hasStream ? 
                            `<div class="video-container">
                                <video id="video-${camera['ID']}" class="live-video" muted autoplay>
                                    <p>Live stream not available</p>
                                </video>
                                <div class="stream-info">
                                    <span class="stream-status loading">Loading...</span>
                                </div>
                            </div>` : 
                            `<div class="standby-container">
                                <div class="standby-screen">
                                    <div class="standby-bars">
                                        <div class="bar"></div>
                                        <div class="bar"></div>
                                        <div class="bar"></div>
                                        <div class="bar"></div>
                                        <div class="bar"></div>
                                    </div>
                                    <div class="standby-text">STANDBY</div>
                                </div>
                            </div>`
                        }
                    </td>
                    <td><strong>${camera['Camera-ID']}</strong></td>
                    <td>${formatLocationWithCountry(camera['Location'], camera['Address'])}</td>
                    <td>${camera['Arena'] || '-'}</td>
                    <td>${formatIPAddress(camera['IP Address'], camera['ID'])}</td>
                    <td>${camera['Installation Date'] || '-'}</td>
                    <td><span class="status-badge active">Active</span></td>
                    <td>
                        <button class="details-btn" onclick="openCameraDetailsModal('${camera['Camera-ID']}')">
                            <i class="info-icon">ℹ</i> Details
                        </button>
                    </td>
                    <td>
                        <button class="edit-btn" onclick="openEditCameraModal('${camera['ID']}')">
                            Edit
                        </button>
                    </td>
                `;
                
                // Live-Stream laden falls verfügbar
                if (hasStream) {
                    setTimeout(() => initHLSStream(camera['ID'], serverId), 100 * index);
                }
            });
        }
        
        // Zu installierende Kameras anzeigen
        function displayPendingCameras(selectedCountry = '') {
            const tbody = document.getElementById('pendingCamerasBody');
            tbody.innerHTML = '';
            
            let pendingCameras = camerasData.filter(camera => {
                const status = camera['Status'];
                return status === '' || 
                       status === 'pending' || 
                       status === 'Installation' ||
                       status === 'Pending Installation' ||
                       (!status && camera['Camera-ID']);
            });
            pendingCameras = sortCamerasByCountry(pendingCameras, selectedCountry);
            
            pendingCameras.forEach(camera => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><strong>${camera['Camera-ID'] || '-'}</strong></td>
                    <td>${formatLocationWithCountry(camera['Location'], camera['Address'])}</td>
                    <td>${camera['Arena'] || '-'}</td>
                    <td>${camera['Installation Type'] || '-'}</td>
                    <td>${camera['Address'] || '-'}</td>
                    <td><span class="status-badge pending">Pending Installation</span></td>
                    <td>
                        <button class="details-btn" onclick="openCameraDetailsModal('${camera['Camera-ID']}')">
                            <i class="info-icon">ℹ</i> Details
                        </button>
                    </td>
                    <td>
                        <button class="edit-btn" onclick="openEditCameraModal('${camera['ID']}')">
                            Edit
                        </button>
                    </td>
                `;
            });
        }
        
        // Inaktive Kameras anzeigen  
        function displayInactiveCameras(selectedCountry = '') {
            const tbody = document.getElementById('inactiveCamerasBody');
            tbody.innerHTML = '';
            
            let inactiveCameras = camerasData.filter(camera => {
                const status = camera['Status'];
                return status === 'Inactive' || 
                       status === 'Storage' || 
                       status === 'Offline' ||
                       status === 'Decommissioned' ||
                       status === 'Stored';
            });
            inactiveCameras = sortCamerasByCountry(inactiveCameras, selectedCountry);
            
            inactiveCameras.forEach(camera => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><strong>${camera['Camera-ID'] || '-'}</strong></td>
                    <td>${formatLocationWithCountry(camera['Location'], camera['Address'])}</td>
                    <td>${camera['Arena'] || '-'}</td>
                    <td>${formatIPAddress(camera['IP Address'], camera['ID'])}</td>
                    <td>${camera['Uninstallation Date'] || '-'}</td>
                    <td><span class="status-badge inactive">Inactive</span></td>
                    <td>
                        <button class="details-btn" onclick="openCameraDetailsModal('${camera['Camera-ID']}')">
                            <i class="info-icon">ℹ</i> Details
                        </button>
                    </td>
                    <td>
                        <button class="edit-btn" onclick="openEditCameraModal('${camera['ID']}')">
                            Edit
                        </button>
                    </td>
                `;
            });
        }
        
        // HLS-Stream initialisieren
        function initHLSStream(cameraId, serverId) {
            const video = document.getElementById(`video-${cameraId}`);
            const statusElement = video.parentElement.querySelector('.stream-status');
            
            if (!video || !serverId) {
                if (statusElement) statusElement.textContent = 'No stream available';
                return;
            }
            
            const streamUrl = `https://ingest-${serverId}.clipmyhorse.tv:9443/ingest/outstream_low/playlist.m3u8`;
            
            console.log(`Loading HLS stream for Camera ${cameraId}: ${streamUrl}`);
            
            // Timeout für Stream-Loading (10 Sekunden)
            const loadTimeout = setTimeout(() => {
                console.log(`Stream loading timeout for Camera ${cameraId}, showing standby display`);
                showStandbyDisplay(cameraId);
                if (hlsPlayers[cameraId]) {
                    hlsPlayers[cameraId].destroy();
                    delete hlsPlayers[cameraId];
                }
            }, 10000);
            
            if (Hls.isSupported()) {
                const hls = new Hls({
                    enableWorker: false,
                    lowLatencyMode: true,
                    backBufferLength: 90
                });
                
                hls.loadSource(streamUrl);
                hls.attachMedia(video);
                
                hls.on(Hls.Events.MANIFEST_PARSED, function() {
                    console.log(`HLS manifest loaded for Camera ${cameraId}`);
                    clearTimeout(loadTimeout); // Stream erfolgreich geladen
                    if (statusElement) {
                        statusElement.textContent = 'Live';
                        statusElement.className = 'stream-status live';
                    }
                    video.play().catch(e => {
                        console.log(`Autoplay prevented for Camera ${cameraId}:`, e);
                    });
                });
                
                hls.on(Hls.Events.ERROR, function(event, data) {
                    console.error(`HLS error for Camera ${cameraId}:`, data);
                    
                    if (data.fatal) {
                        clearTimeout(loadTimeout); // Timeout löschen bei Fehler
                        console.log(`Fatal error for Camera ${cameraId}, showing standby display`);
                        showStandbyDisplay(cameraId);
                        hls.destroy();
                        delete hlsPlayers[cameraId];
                    } else {
                        // Nicht-fatale Fehler: Versuche Recovery
                        if (statusElement) {
                            statusElement.textContent = 'Reconnecting...';
                            statusElement.className = 'stream-status loading';
                        }
                        
                        switch(data.type) {
                            case Hls.ErrorTypes.NETWORK_ERROR:
                                console.log(`Network error for Camera ${cameraId}, trying to recover...`);
                                setTimeout(() => hls.startLoad(), 1000);
                                break;
                            case Hls.ErrorTypes.MEDIA_ERROR:
                                console.log(`Media error for Camera ${cameraId}, trying to recover...`);
                                hls.recoverMediaError();
                                break;
                        }
                    }
                });
                
                // HLS-Instanz speichern für spätere Verwendung
                hlsPlayers[cameraId] = hls;
                
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                // Fallback für Safari
                video.src = streamUrl;
                video.addEventListener('loadedmetadata', function() {
                    clearTimeout(loadTimeout); // Stream erfolgreich geladen
                    if (statusElement) {
                        statusElement.textContent = 'Live';
                        statusElement.className = 'stream-status live';
                    }
                    video.play().catch(e => {
                        console.log(`Autoplay prevented for Camera ${cameraId}:`, e);
                    });
                });
                
                video.addEventListener('error', function() {
                    clearTimeout(loadTimeout); // Timeout löschen bei Fehler
                    console.log(`Video error for Camera ${cameraId}, showing standby display`);
                    showStandbyDisplay(cameraId);
                });
            } else {
                clearTimeout(loadTimeout); // Timeout löschen 
                console.log(`HLS not supported for Camera ${cameraId}, showing standby display`);
                showStandbyDisplay(cameraId);
            }
        }
        
        // Standby-Display anzeigen (ersetzt Video-Player bei Fehlern)
        function showStandbyDisplay(cameraId) {
            const video = document.getElementById(`video-${cameraId}`);
            if (!video) return;
            
            const streamCell = video.closest('.stream-cell');
            if (!streamCell) return;
            
            // Video-Container durch Standby-Display ersetzen
            streamCell.innerHTML = `
                <div class="standby-container">
                    <div class="standby-screen">
                        <div class="standby-bars">
                            <div class="bar"></div>
                            <div class="bar"></div>
                            <div class="bar"></div>
                            <div class="bar"></div>
                            <div class="bar"></div>
                        </div>
                        <div class="standby-text">STANDBY</div>
                    </div>
                </div>
            `;
        }
        
        // Cleanup beim Verlassen der Seite
        window.addEventListener('beforeunload', function() {
            Object.values(hlsPlayers).forEach(hls => {
                if (hls) hls.destroy();
            });
        });
        
        // Kamera-Details Modal öffnen
        async function openCameraDetailsModal(cameraId) {
            try {
                // Modal anzeigen
                document.getElementById('cameraDetailsModal').style.display = 'block';
                document.body.style.overflow = 'hidden';
                
                // Titel setzen
                document.getElementById('cameraDetailsTitle').textContent = `Camera ${cameraId} - Details`;
                
                // Loading-Anzeige
                document.getElementById('cameraDetailsContent').innerHTML = '<p>Loading camera details...</p>';
                document.getElementById('cameraImageGallery').innerHTML = '<p>Loading images...</p>';
                
                // Kamera-Details laden
                await loadCameraDetails(cameraId);
                
                // Bilder laden
                await loadCameraImages(cameraId);
                
            } catch (error) {
                console.error('Fehler beim Laden der Kamera-Details:', error);
                document.getElementById('cameraDetailsContent').innerHTML = '<p class="error">Error loading camera details</p>';
                document.getElementById('cameraImageGallery').innerHTML = '<p class="error">Error loading images</p>';
            }
        }
        
        // Kamera-Details Modal schließen
        function closeCameraDetailsModal() {
            document.getElementById('cameraDetailsModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }
        
        // Kamera-Details aus CSV laden
        async function loadCameraDetails(cameraId) {
            try {
                const response = await fetch(`camera_details_${cameraId}.csv`);
                if (!response.ok) {
                    throw new Error(`Details for camera ${cameraId} not found`);
                }
                
                const csvText = await response.text();
                const details = parseCSV(csvText);
                
                displayCameraDetails(details);
                
            } catch (error) {
                console.error('Fehler beim Laden der Details:', error);
                document.getElementById('cameraDetailsContent').innerHTML = 
                    `<p class="error">Details for Camera ${cameraId} not available</p>`;
            }
        }
        
        // Kamera-Details anzeigen
        function displayCameraDetails(details) {
            const container = document.getElementById('cameraDetailsContent');
            let html = '';
            
            details.forEach(detail => {
                const field = detail['Field'];
                const value = detail['Value'];
                
                if (field && value) {
                    // Spezielle Formatierung für bestimmte Felder
                    let displayValue = value;
                    let displayField = field.replace(/-/g, ' ').replace(/([A-Z])/g, ' $1').trim();
                    
                    // Links für URLs
                    if (field.includes('Link') || field.includes('Address') && value.includes('.')) {
                        displayValue = `<a href="http://${value}" target="_blank" class="detail-link">${value}</a>`;
                    }
                    
                    // Highlight für wichtige Felder
                    const isImportant = ['PIN', 'PUK', 'SIM-Number', 'Audio-Mixer-Link'].includes(field);
                    const fieldClass = isImportant ? 'detail-field important' : 'detail-field';
                    
                    html += `
                        <div class="detail-item">
                            <div class="${fieldClass}">${displayField}:</div>
                            <div class="detail-value">${displayValue}</div>
                        </div>
                    `;
                }
            });
            
            container.innerHTML = html || '<p>No details available</p>';
        }
        
        // Kamera-Bilder laden
        async function loadCameraImages(cameraId) {
            try {
                // Versuche Bilder von 1-10 zu laden
                const imageContainer = document.getElementById('cameraImageGallery');
                let imagesHtml = '';
                let foundImages = 0;
                
                for (let i = 1; i <= 10; i++) {
                    const imagePath = `camera_images/${cameraId}/${cameraId}_${i.toString().padStart(2, '0')}.jpg`;
                    
                    try {
                        const response = await fetch(imagePath, { method: 'HEAD' });
                        if (response.ok) {
                            foundImages++;
                            imagesHtml += `
                                <div class="image-item">
                                    <img src="${imagePath}" alt="Camera ${cameraId} Image ${i}" 
                                         onclick="openImageFullscreen('${imagePath}')" 
                                         onerror="this.parentElement.style.display='none'">
                                    <div class="image-caption">Image ${i}</div>
                                </div>
                            `;
                        }
                    } catch (error) {
                        // Bild nicht gefunden, weiter
                    }
                }
                
                if (foundImages === 0) {
                    // Alternative: Versuche andere Formate
                    const alternativeFormats = ['png', 'jpeg', 'gif'];
                    for (const format of alternativeFormats) {
                        const imagePath = `camera_images/${cameraId}/${cameraId}_01.${format}`;
                        try {
                            const response = await fetch(imagePath, { method: 'HEAD' });
                            if (response.ok) {
                                imagesHtml += `
                                    <div class="image-item">
                                        <img src="${imagePath}" alt="Camera ${cameraId} Image" 
                                             onclick="openImageFullscreen('${imagePath}')"
                                             onerror="this.parentElement.style.display='none'">
                                        <div class="image-caption">Camera Image</div>
                                    </div>
                                `;
                                foundImages++;
                                break;
                            }
                        } catch (error) {
                            // Format nicht gefunden
                        }
                    }
                }
                
                imageContainer.innerHTML = foundImages > 0 ? imagesHtml : 
                    `<p class="no-images">No images available for Camera ${cameraId}</p>`;
                
            } catch (error) {
                console.error('Fehler beim Laden der Bilder:', error);
                document.getElementById('cameraImageGallery').innerHTML = 
                    `<p class="error">Error loading images for Camera ${cameraId}</p>`;
            }
        }
        
        // Bild im Vollbild öffnen
        function openImageFullscreen(imagePath) {
            const fullscreenDiv = document.createElement('div');
            fullscreenDiv.className = 'image-fullscreen';
            fullscreenDiv.innerHTML = `
                <div class="fullscreen-content">
                    <img src="${imagePath}" alt="Fullscreen Image">
                    <span class="fullscreen-close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                </div>
            `;
            
            fullscreenDiv.onclick = function(e) {
                if (e.target === fullscreenDiv) {
                    fullscreenDiv.remove();
                }
            };
            
            document.body.appendChild(fullscreenDiv);
        }
        
        // Modal für neue Kamera öffnen
        function openAddCameraModal() {
            // Formular zurücksetzen
            document.getElementById('addCameraForm').reset();
            
            // Modal anzeigen
            document.getElementById('addCameraModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }
        
        // Modal für neue Kamera schließen
        function closeAddCameraModal() {
            document.getElementById('addCameraModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }
        
        // Modal für Kamera-Bearbeitung öffnen
        function openEditCameraModal(cameraRowId) {
            currentEditingCameraId = cameraRowId;
            
            // Kamera finden
            const camera = camerasData.find(c => c['ID'] === cameraRowId);
            if (!camera) {
                alert('Camera not found!');
                return;
            }
            
            // Formular mit aktuellen Werten füllen
            document.getElementById('editCameraRowId').value = cameraRowId;
            document.getElementById('editCameraId').value = camera['Camera-ID'] || '';
            document.getElementById('editLocation').value = camera['Location'] || '';
            document.getElementById('editAddress').value = camera['Address'] || '';
            document.getElementById('editArena').value = camera['Arena'] || '';
            document.getElementById('editInstallationType').value = camera['Installation Type'] || '';
            document.getElementById('editIpAddress').value = camera['IP Address'] || '';
            document.getElementById('editInstallationDate').value = camera['Installation Date'] || '';
            document.getElementById('editUninstallationDate').value = camera['Uninstallation Date'] || '';
            document.getElementById('editServerId').value = camera['Server-ID'] || '';
            document.getElementById('editStatus').value = camera['Status'] || '';
            document.getElementById('editEventManager').value = camera['Event Manager'] || '';
            document.getElementById('editLocalContact').value = camera['Local Contact'] || '';
            
            // Modal anzeigen
            document.getElementById('editCameraModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }
        
        // Modal für Kamera-Bearbeitung schließen
        function closeEditCameraModal() {
            document.getElementById('editCameraModal').style.display = 'none';
            document.body.style.overflow = 'auto';
            currentEditingCameraId = null;
        }
        
        // Neue Kamera speichern
        function saveNewCamera() {
            // Formular-Daten sammeln
            const form = document.getElementById('addCameraForm');
            const formData = new FormData(form);
            
            // Validierung
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            // Neue ID generieren
            const maxId = Math.max(...camerasData.map(c => parseInt(c['ID']) || 0));
            const newId = (maxId + 1).toString();
            
            // Neue Kamera erstellen
            const newCamera = {
                'ID': newId,
                'Camera-ID': formData.get('cameraId'),
                'Location': formData.get('location'),
                'Address': formData.get('address') || '',
                'Arena': formData.get('arena') || '',
                'Installation Type': formData.get('installationType') || '',
                'IP Address': formData.get('ipAddress') || '',
                'Installation Date': formData.get('installationDate') || '',
                'Uninstallation Date': '',
                'Status': formData.get('status') || '',
                'Event Manager': formData.get('eventManager') || '',
                'Local Contact': formData.get('localContact') || '',
                'Server-ID': formData.get('serverId') || ''
            };
            
            // Zu Daten hinzufügen
            camerasData.push(newCamera);
            
            // Lokale Speicherung
            saveCamerasToLocalStorage();
            
            // UI aktualisieren
            displayActiveCameras();
            displayPendingCameras();
            displayInactiveCameras();
            
            // Modal schließen
            closeAddCameraModal();
            
            alert('Camera successfully added!');
        }
        
        // Bearbeitete Kamera speichern
        function saveEditedCamera() {
            if (!currentEditingCameraId) return;
            
            // Formular-Daten sammeln
            const form = document.getElementById('editCameraForm');
            const formData = new FormData(form);
            
            // Validierung
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            // Kamera finden und aktualisieren
            const cameraIndex = camerasData.findIndex(c => c['ID'] === currentEditingCameraId);
            if (cameraIndex === -1) {
                alert('Camera not found!');
                return;
            }
            
            // Kamera aktualisieren
            camerasData[cameraIndex] = {
                'ID': currentEditingCameraId,
                'Camera-ID': formData.get('editCameraId'),
                'Location': formData.get('editLocation'),
                'Address': formData.get('editAddress') || '',
                'Arena': formData.get('editArena') || '',
                'Installation Type': formData.get('editInstallationType') || '',
                'IP Address': formData.get('editIpAddress') || '',
                'Installation Date': formData.get('editInstallationDate') || '',
                'Uninstallation Date': formData.get('editUninstallationDate') || '',
                'Status': formData.get('editStatus') || '',
                'Event Manager': formData.get('editEventManager') || '',
                'Local Contact': formData.get('editLocalContact') || '',
                'Server-ID': formData.get('editServerId') || ''
            };
            
            // Lokale Speicherung
            saveCamerasToLocalStorage();
            
            // UI aktualisieren
            displayActiveCameras();
            displayPendingCameras();
            displayInactiveCameras();
            
            // Modal schließen
            closeEditCameraModal();
            
            alert('Camera successfully updated!');
        }
        
        // Kamera löschen
        function deleteCamera() {
            if (!currentEditingCameraId) return;
            
            if (!confirm('Are you sure you want to delete this camera? This action cannot be undone.')) {
                return;
            }
            
            // Kamera finden und entfernen
            const cameraIndex = camerasData.findIndex(c => c['ID'] === currentEditingCameraId);
            if (cameraIndex === -1) {
                alert('Camera not found!');
                return;
            }
            
            // Aus Daten entfernen
            camerasData.splice(cameraIndex, 1);
            
            // Lokale Speicherung
            saveCamerasToLocalStorage();
            
            // UI aktualisieren
            displayActiveCameras();
            displayPendingCameras();
            displayInactiveCameras();
            
            // Modal schließen
            closeEditCameraModal();
            
            alert('Camera successfully deleted!');
        }
        
        // Kameras im localStorage speichern
        function saveCamerasToLocalStorage() {
            localStorage.setItem('camerasData', JSON.stringify(camerasData));
        }
        
        // Land aus Adresse extrahieren
        function extractCountryFromAddress(address) {
            if (!address) return 'Unknown';
            
            const countryMappings = {
                'Germany': 'Germany',
                'Deutschland': 'Germany',
                'USA': 'USA',
                'United States': 'USA',
                'Netherlands': 'Netherlands',
                'Nederland': 'Netherlands',
                'UK': 'United Kingdom',
                'United Kingdom': 'United Kingdom'
            };
            
            // Nach bekannten Ländern suchen
            for (const [key, value] of Object.entries(countryMappings)) {
                if (address.toLowerCase().includes(key.toLowerCase())) {
                    return value;
                }
            }
            
            // Falls nicht gefunden, letzten Teil der Adresse nehmen
            const parts = address.split(',').map(part => part.trim());
            return parts[parts.length - 1] || 'Unknown';
        }
        
        // Länder-Dropdown befüllen
        function populateCountryFilter() {
            const countries = new Set();
            
            camerasData.forEach(camera => {
                const country = extractCountryFromAddress(camera['Address']);
                countries.add(country);
            });
            
            const select = document.getElementById('countryFilter');
            const currentValue = select.value;
            
            // Optionen löschen (außer "All Countries")
            while (select.options.length > 1) {
                select.remove(1);
            }
            
            // Länder sortiert hinzufügen
            Array.from(countries).sort().forEach(country => {
                const option = document.createElement('option');
                option.value = country;
                option.textContent = country;
                select.appendChild(option);
            });
            
            // Vorherigen Wert wiederherstellen
            select.value = currentValue;
        }
        
        // Country-Filter anwenden
        function applyCountryFilter() {
            const selectedCountry = document.getElementById('countryFilter').value;
            
            // Alle Tabellen neu laden mit Filter
            displayActiveCameras(selectedCountry);
            displayPendingCameras(selectedCountry);
            displayInactiveCameras(selectedCountry);
        }
        
        // Location mit Land formatieren
        function formatLocationWithCountry(location, address) {
            const country = extractCountryFromAddress(address);
            if (country === 'Unknown' || !location) {
                return location || '-';
            }
            return `${location} (${country})`;
        }
        
        // Kameras nach Land sortieren
        function sortCamerasByCountry(cameras, selectedCountry) {
            if (!selectedCountry) return cameras;
            
            return cameras.sort((a, b) => {
                const countryA = extractCountryFromAddress(a['Address']);
                const countryB = extractCountryFromAddress(b['Address']);
                
                if (countryA === selectedCountry && countryB !== selectedCountry) return -1;
                if (countryA !== selectedCountry && countryB === selectedCountry) return 1;
                return 0;
            });
        }
        
        // IP-Adresse formatieren mit Erreichbarkeitsprüfung
        function formatIPAddress(ipAddress, cameraId) {
            if (!ipAddress || ipAddress.trim() === '') {
                return '-';
            }
            
            const cleanIP = ipAddress.trim();
            const statusId = `ip-status-${cameraId}`;
            
            // IP-Adresse als anklickbarer Link mit Status-Icon
            const html = `
                <span class="ip-container">
                    <a href="http://${cleanIP}" target="_blank" class="ip-link" title="Open ${cleanIP} in new window">
                        ${cleanIP}
                    </a>
                    <span id="${statusId}" class="ip-status" title="Checking connectivity...">
                        <span class="ip-spinner">⟳</span>
                    </span>
                </span>
            `;
            
            // IP-Erreichbarkeit asynchron prüfen
            setTimeout(() => checkIPConnectivity(cleanIP, statusId), 500);
            
            return html;
        }
        
        // IP-Erreichbarkeit prüfen
        async function checkIPConnectivity(ipAddress, statusId) {
            const statusElement = document.getElementById(statusId);
            if (!statusElement) return;
            
            try {
                // Versuche verschiedene Ports/Protokolle
                const testUrls = [
                    `http://${ipAddress}`,
                    `http://${ipAddress}:80`,
                    `http://${ipAddress}:8080`,
                    `http://${ipAddress}:8888`
                ];
                
                let isReachable = false;
                
                for (const url of testUrls) {
                    try {
                        // Timeout-basierte Anfrage mit AbortController
                        const controller = new AbortController();
                        const timeout = setTimeout(() => controller.abort(), 3000);
                        
                        const response = await fetch(url, {
                            method: 'HEAD',
                            mode: 'no-cors', // Umgeht CORS-Probleme
                            signal: controller.signal
                        });
                        
                        clearTimeout(timeout);
                        isReachable = true;
                        break;
                        
                    } catch (error) {
                        // Auch bei CORS-Fehlern könnte der Server erreichbar sein
                        if (error.name !== 'AbortError') {
                            isReachable = true; // Antwort erhalten = Server erreichbar
                            break;
                        }
                    }
                }
                
                // Status-Icon aktualisieren
                if (isReachable) {
                    statusElement.innerHTML = '<span class="ip-success" title="IP Address is reachable">✓</span>';
                    statusElement.className = 'ip-status success';
                } else {
                    statusElement.innerHTML = '<span class="ip-error" title="IP Address is not reachable">⚠</span>';
                    statusElement.className = 'ip-status error';
                }
                
            } catch (error) {
                console.log(`IP check failed for ${ipAddress}:`, error);
                statusElement.innerHTML = '<span class="ip-error" title="Could not check IP connectivity">⚠</span>';
                statusElement.className = 'ip-status error';
            }
        }
        
        // Modal schließen beim Klick außerhalb (erweitert)
        window.onclick = function(event) {
            const addModal = document.getElementById('addProductionModal');
            const editModal = document.getElementById('editProductionModal');
            const detailsModal = document.getElementById('cameraDetailsModal');
            const addCameraModal = document.getElementById('addCameraModal');
            const editCameraModal = document.getElementById('editCameraModal');
            
            if (event.target === addModal) {
                closeAddProductionModal();
            }
            if (event.target === editModal) {
                closeEditProductionModal();
            }
            if (event.target === detailsModal) {
                closeCameraDetailsModal();
            }
            if (event.target === addCameraModal) {
                closeAddCameraModal();
            }
            if (event.target === editCameraModal) {
                closeEditCameraModal();
            }
        }
        
        // Equipment-Daten beim Laden der Seite laden
        document.addEventListener('DOMContentLoaded', loadEquipmentData);
    </script>
</body>
</html> 